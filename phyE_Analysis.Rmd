---
title: "phyE mutant analysis"
author: "Julin Maloof"
date: "August 10, 2015"
output: html_document
---

## Load the data and libraries

```{r, results='hide'}
library(ggplot2)
library(lme4)
library(lmerTest)
library(multcomp)
data <- read.csv("phyintpetbothreps.csv")
head(data)
summary(data)
data <- data[,!grepl("X",colnames(data))] # get rid of time stamp columns
summary(data)
data$treatment <- relevel(data$treatment,ref="sun")
data$genotype <- factor(data$genotype,levels=c("MM","A","B1","B2","E3","E7","B12","1E3","1E7","2E3","2E7","TR3","TR7","QD3","QD7"))
data$rep <- factor(data$rep)
data$start <- factor(data$start)
```

## Focus on E7

if we want to only focus on E7, uncomment and run the following
```{r, eval=FALSE}
#not run
data <- data[!grepl("3",data$genotype),]
data <- droplevels(data)
```


## Coefficient of variation for each organ
I am curious as to which data have the least "noise" or residual variation.  One way to do this is to calculate the coefficient of variation.  CV is standard dev / mean.  I am also curious, for the internodes, what combining them looks like.

```{r}
data <- within(data,{
  epi.int1 <- epi+int1
  epi.int12 <- epi+int1+int2 # from the perspective of having worked with the plants, this seems best.
  epi.int123 <- epi+int1+int2+int3
})
with(data,{
  sapply(names(data)[7:17],function(x) {
    means <- tapply(get(x),list(genotype,treatment,rep),mean,na.rm=T)
    sdevs <- tapply(get(x),list(genotype,treatment,rep),sd,na.rm=T)
    mean(sdevs/means,na.rm=T)
  })
})
```

Conclusion: earlier organs are better.  Combining epi+int1 is also good; combining all shoot organs may be reasonable.

## Modelling for individual organs

Use a mixed effect model to take into account random variation, like rep and shelf.

First create the "shelf" variable.
```{r}
data$shelf <- sapply(as.character(data$start),switch,
                     "1" = "top",
                     "2" = "middle",
                     "3" = "bottom",
                     "4" = "top",
                     "5" = "middle",
                     "6" = "bottom")
```

A model for epi.  Start with full model, compare to simpler models.  Keep simplest model that still fits well.
```{r}
lmer.epi1 <- lmer(epi ~ genotype*treatment + (1|rep) + (1|shelf) + (1|start), data=data)
lmer.epi2 <- lmer(epi ~ genotype*treatment + (1|rep) + (1|start), data=data)
anova(lmer.epi1,lmer.epi2) # no pref; drop shelf
lmer.epi3 <- lmer(epi ~ genotype*treatment + (1|start), data=data)
anova(lmer.epi2,lmer.epi3) # keep rep
lmer.epi4 <- lmer(epi ~ genotype*treatment + (1|rep), data=data)
anova(lmer.epi2,lmer.epi4) # drop start on full data set (but not if using E7 only!)
summary(lmer.epi4) #final model.
```

Get predictions from model for plotting.  First create a data frame to hold the results.  Then use `predict()` to get the BLUPs and finally extract the errors from the model.
```{r}
epi.results <- data.frame(
  genotype=rep(levels(data$genotype),2),
  treatment=rep(levels(data$treatment),each=nlevels(data$genotype))
)
epi.results$epi <- predict(lmer.epi4,epi.results,re.form=NA)
head(epi.results)

#confint95 <- confint(lmer.epi4,parm="beta_",method="boot",nsim=1000) 
#because these are centered on the coefficients rather than on the final estimates we need to do some conversion
#confint95.adj <- confint95-fixef(lmer.epi4)+epi.results$epi

#add to the df
#epi.results$confint95.low <- confint95.adj[,1] 
#epi.results$confint95.high <- confint95.adj[,2]
#epi.results

#Although less precise we can also add the s.e.m from the original fit.
#Because the standard in our field for plots is s.e.m this will make a more "traditional" plot

epi.results$sem.low <- epi.results$epi - summary(lmer.epi4)$coefficients[,"Std. Error"]
epi.results$sem.high <- epi.results$epi + summary(lmer.epi4)$coefficients[,"Std. Error"]
```

plot it
```{r}
epi.results$treatment <- relevel(epi.results$treatment,ref="sun")
epi.results$genotype <- factor(epi.results$genotype,levels=c("MM","A","B1","B2","E3","E7","B12","1E3","1E7","2E3","2E7","TR3","TR7","QD3","QD7"))
pl <- ggplot(epi.results,aes(x=genotype,fill=treatment,y=epi))
pl <- pl + geom_bar(stat="identity",position="dodge")
pl <- pl + geom_errorbar(aes(ymin=sem.low,ymax=sem.high),position=position_dodge(width=.9),width=.5)
pl + scale_fill_manual(values=c("skyblue","darkred")) # feel free to change
```

## epi+int1+int2

```{r}
lmer.epi.int12_1 <- lmer(epi.int12 ~ genotype*treatment + (1|rep) + (1|shelf) + (1|start), data=data)
lmer.epi.int12_2 <- lmer(epi.int12 ~ genotype*treatment + (1|rep) + (1|start), data=data)
anova(lmer.epi.int12_1,lmer.epi.int12_2) # no pref; drop shelf
lmer.epi.int12_3 <- lmer(epi.int12 ~ genotype*treatment + (1|start), data=data)
anova(lmer.epi.int12_2,lmer.epi.int12_3) # keep rep
lmer.epi.int12_4 <- lmer(epi.int12 ~ genotype*treatment + (1|rep), data=data)
anova(lmer.epi.int12_2,lmer.epi.int12_4) # keep start
summary(lmer.epi.int12_2) #final model.
```

Get predictions from model for plotting.  First create a data frame to hold the results.  Then use `predict()` to get the BLUPs and finally extract the errors from the model.
```{r}
epi.int12.results <- data.frame(
  genotype=rep(levels(data$genotype),2),
  treatment=rep(levels(data$treatment),each=nlevels(data$genotype))
)
epi.int12.results$epi.int12 <- predict(lmer.epi.int12_2,epi.int12.results,re.form=NA)
head(epi.int12.results)

#confint95 <- confint(lmer.epi.int12_4,parm="beta_",method="boot",nsim=1000) 
#because these are centered on the coefficients rather than on the final estimates we need to do some conversion
#confint95.adj <- confint95-fixef(lmer.epi.int12_4)+epi.int12.results$epi.int12

#add to the df
#epi.int12.results$confint95.low <- confint95.adj[,1] 
#epi.int12.results$confint95.high <- confint95.adj[,2]
#epi.int12.results

#Although less precise we can also add the s.e.m from the original fit.
#Because the standard in our field for plots is s.e.m this will make a more "traditional" plot

epi.int12.results$sem.low <- epi.int12.results$epi.int12 - summary(lmer.epi.int12_2)$coefficients[,"Std. Error"]
epi.int12.results$sem.high <- epi.int12.results$epi.int12 + summary(lmer.epi.int12_2)$coefficients[,"Std. Error"]
```

plot it
```{r}
epi.int12.results$treatment <- relevel(epi.int12.results$treatment,ref="sun")
epi.int12.results$genotype <- factor(epi.int12.results$genotype,levels=c("MM","A","B1","B2","E3","E7","B12","1E3","1E7","2E3","2E7","TR3","TR7","QD3","QD7"))
pl <- ggplot(epi.int12.results,aes(x=genotype,fill=treatment,y=epi.int12))
pl <- pl + geom_bar(stat="identity",position="dodge")
pl <- pl + geom_errorbar(aes(ymin=sem.low,ymax=sem.high),position=position_dodge(width=.9),width=.5)
pl + scale_fill_manual(values=c("skyblue","darkred")) # feel free to change

#to subset
epi.int12.results.singles <- epi.int12.results[epi.int12.results$genotype %in% c("MM","A","B1","B2","E7"),] #i.e. for singles
pl <- ggplot(epi.int12.results.singles,aes(x=genotype,fill=treatment,y=epi.int12))
pl <- pl + geom_bar(stat="identity",position="dodge")
pl <- pl + geom_errorbar(aes(ymin=sem.low,ymax=sem.high),position=position_dodge(width=.9),width=.5)
pl + scale_fill_manual(values=c("skyblue","darkred")) # feel free to change
```

### figure out multiple comparisons
```{r}
names(fixef(lmer.epi.int12_2)) # the contrasts that we can make
difflsmeans(lmer.epi.int12_2)
```

